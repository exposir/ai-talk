## 十七、性能与稳定性设计

> 导读：性能与稳定性是核心卖点，单独作为设计章节。

### 17.1 低层性能优化策略

- **数据结构**：
  - 依赖图使用邻接表 + Set，避免全量遍历
  - 节点状态用版本号而非深比较
- **调度**：
  - 写入聚合后一次性派发通知
  - 使用微任务队列减少同步抖动
- **订阅**：
  - 精确依赖追踪，避免无关订阅触发
  - 订阅集合使用 Set 去重
- **内存**：
  - 弱引用管理短生命周期节点
  - 事件流可配置采样与窗口大小

### 17.2 稳定性保障策略

- **一致性**：批次快照与写合并保证可预测性
- **错误隔离**：effect 异常记录不阻断后续更新
- **资源释放**：effect 必须显式 dispose，避免泄漏
- **协作安全**：CRDT 合并与离线回放保证最终一致

---


## 十八、DevTools UI 设计

> 导读：描述 DevTools 交互目标与基本布局。

### 18.1 面板布局

- **左侧**：状态树 + 搜索
- **中间**：时间线 (TraceEvent)
- **右侧**：当前节点详情 + 依赖图

### 18.2 交互能力

- **时间旅行**：回放到任意事件
- **过滤**：按 nodeId/type 筛选
- **快照导出**：JSON 导出用于审计

### 18.3 数据导出规范

- **格式**：`TraceExport`，包含 `protocolVersion/events/snapshots`。
- **脱敏**：支持字段级脱敏。
- **容量**：默认保留最近 N 条事件。

### 18.4 协议版本

- **版本字段**：导出数据包含 `protocolVersion`。
- **兼容策略**：次版本向后兼容，主版本可能破坏兼容。

### 18.5 性能与体验

- **轻量采样**：默认仅采样关键事件
- **延迟渲染**：大型状态树按需展开
- **可关闭**：生产环境默认禁用

**性能模式**：
- 提供 `minimal` 采样模式，仅记录 write/async 事件。

---


## 十九、性能基准细化

> 导读：给出基准场景与统计口径。

### 19.1 Benchmark 场景

- **读密集**：1k 订阅 + 10k 次只读访问
- **写密集**：1k 订阅 + 1k 连续写入 (batch)
- **异步密集**：100 并发请求 + 取消与重试

### 19.2 统计口径

- **均值**：总耗时 / 次数
- **P95**：95 分位耗时
- **内存**：操作前后堆内存差值

### 19.3 基线目标 (初版)

- **1k 订阅**：单次批量更新 < 8ms (P95)
- **1k 连续写**：批次渲染合并为 1 次
- **100 并发**：取消语义无泄漏

### 19.3.1 领先目标 (强化版)

- **稳定性优先**：长时间运行无内存泄漏、无一致性异常
- **性能领先**：核心路径（读/写/批处理）目标超越主流竞品基线
- **可预测性**：高负载下 P95 不明显劣化

### 19.3.2 达成路径 (技术细节)

- **稳定性技术**：
  - 依赖图检测环路，循环依赖立即抛错并记录 TraceEvent
  - effect 生命周期显式管理，统一 dispose，防止泄漏
  - async 取消/过期响应丢弃，避免脏写
  - Store 级隔离（SSR/并发）避免跨请求污染
- **性能技术**：
  - 细粒度订阅 + 依赖追踪，避免全量渲染
  - 批处理合并写入，减少通知与渲染次数
  - minimal 采样模式降低 DevTools 运行时开销
  - 缓存与去重减少重复请求与计算

### 19.4 Benchmark 步骤

1) 准备固定数据规模与设备环境
2) 执行 3 轮测试取均值
3) 记录均值与 P95

**测量方法**：
- 使用 `performance.now()` 统计单次批次耗时。
- 每轮至少 100 次迭代。

### 19.5 报告模板

```
环境:
场景:
均值:
P95:
内存差:
备注:
```

### 19.6 对标计划

- **对标对象**：Zustand、Jotai、Legend-State、Redux Toolkit
- **场景对齐**：同样的数据规模、订阅数量与更新频率
- **指标对比**：均值/P95/内存差/稳定性（长跑测试）

---

