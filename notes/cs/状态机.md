# 状态机 (State Machine)

## 历史起源

### 理论基础的奠定

**1936年 - 图灵机 (Turing Machine)**

艾伦·图灵（Alan
Turing）提出了图灵机的概念，这是现代计算机科学和状态机理论的基石。图灵机本质上是一个无限状态自动机，它定义了：

- 一条无限长的纸带（存储）
- 一个读写头（I/O）
- 一组有限的状态
- 基于当前状态和读取符号的转换规则

**1943年 - 神经网络模型**

沃伦·麦卡洛克（Warren McCulloch）和沃尔特·皮茨（Walter
Pitts）发表了开创性论文《神经活动中内在思想的逻辑演算》，将有限自动机的概念与神经网络联系起来。

**1956年 - 自动机理论形式化**

迈克尔·拉宾（Michael O. Rabin）和达纳·斯科特（Dana
Scott）发表了关于有限自动机的奠基性论文，为此他们获得了1976年图灵奖。他们的工作正式定义了：

- 确定性有限自动机（DFA）
- 非确定性有限自动机（NFA）
- 两者的等价性证明

### 工程应用的发展

**1950-60年代 - 数字电路设计**

状态机理论被广泛应用于数字电路设计，产生了两种经典模型：

- **Moore 机 (1956)**：由 Edward Moore 提出，输出只依赖于当前状态
- **Mealy 机 (1955)**：由 George Mealy 提出，输出依赖于当前状态和输入

**1980年代 - Statecharts**

大卫·哈雷尔（David Harel）于1987年发表了革命性论文《Statecharts: A Visual
Formalism for Complex Systems》，引入了：

- 层次化状态（嵌套状态）
- 并行状态（正交区域）
- 历史状态
- 守卫条件

这一工作对后来的 UML 状态图和现代状态机库产生了深远影响。

---

## 核心概念

### 基本定义

有限状态机（FSM）是一个数学计算模型，由以下五元组定义：

```
M = (Q, Σ, δ, q₀, F)
```

- **Q**：有限状态集合
- **Σ**：有限输入字母表（事件集合）
- **δ**：状态转换函数 δ: Q × Σ → Q
- **q₀**：初始状态，q₀ ∈ Q
- **F**：接受状态集合，F ⊆ Q

### 状态机类型

#### 1. 确定性有限自动机 (DFA)

对于任意状态和输入符号，只有一个确定的下一状态。

```
特点：
- 每个状态对每个输入只有唯一转换
- 不允许 ε（空）转换
- 实现简单，执行效率高
```

#### 2. 非确定性有限自动机 (NFA)

允许多个可能的下一状态，包括不接受任何输入的转换。

```
特点：
- 同一输入可能有多个转换
- 允许 ε 转换
- 表达能力与 DFA 等价（可相互转换）
- 描述更简洁，但实现复杂
```

#### 3. Moore 机 vs Mealy 机

| 特性     | Moore 机       | Mealy 机        |
| -------- | -------------- | --------------- |
| 输出依赖 | 仅当前状态     | 当前状态 + 输入 |
| 状态数量 | 通常更多       | 通常更少        |
| 输出时机 | 进入状态时     | 转换过程中      |
| 稳定性   | 更稳定，无毛刺 | 响应更快        |

---

## 现代扩展

### Hierarchical State Machines (HSM)

层次状态机引入了状态嵌套的概念：

```javascript
// 概念示例
states: {
  playing: {
    initial: 'running',
    states: {
      running: {},
      paused: {}
    }
  },
  gameOver: {}
}
```

**优势**：

- 减少重复转换
- 更好的代码组织
- 支持状态继承

### Extended State Machines

扩展状态机在传统 FSM 基础上增加了：

- **上下文（Context）**：携带额外数据
- **守卫条件（Guards）**：条件化转换
- **动作（Actions）**：副作用执行
- **活动（Activities）**：持续性操作

### Actor Model Integration

现代状态机常与 Actor 模型结合：

```
Actor = 状态机 + 消息队列 + 隔离的状态
```

每个 Actor 是一个独立的计算单元，通过消息传递进行通信。

---

## 应用领域

### 编译器设计

- **词法分析器**：使用 DFA 识别 token
- **正则表达式引擎**：NFA/DFA 实现模式匹配

### 通信协议

- **TCP 状态机**：管理连接的 11 种状态
- **HTTP/2 流状态机**：idle → open → half-closed → closed

### UI 开发

- **表单验证**：pristine → dirty → valid/invalid
- **加载状态**：idle → loading → success/error
- **复杂组件**：模态框、下拉菜单、拖拽交互

### 游戏开发

- **AI 行为**：巡逻 ↔ 追击 ↔ 攻击 ↔ 逃跑
- **游戏状态**：菜单 → 游戏中 → 暂停 → 结束

### 工作流引擎

- **订单系统**：待支付 → 已支付 → 发货中 → 已完成
- **审批流程**：待审核 → 审核中 → 通过/驳回

---

## 状态机的优势

1. **可预测性**：所有可能状态和转换都明确定义
2. **可视化**：易于绘制状态图进行沟通
3. **可测试性**：状态有限，便于穷举测试
4. **避免非法状态**：通过类型系统强制正确性
5. **解耦逻辑**：状态转换逻辑与业务逻辑分离

---

## 经典实现示例

### 交通信号灯

```javascript
const trafficLight = {
  initial: 'green',
  states: {
    green: { on: { TIMER: 'yellow' } },
    yellow: { on: { TIMER: 'red' } },
    red: { on: { TIMER: 'green' } },
  },
};
```

### 状态转换图

```
┌─────────┐  TIMER   ┌─────────┐  TIMER   ┌─────────┐
│  green  │ ───────► │ yellow  │ ───────► │   red   │
└─────────┘          └─────────┘          └─────────┘
     ▲                                         │
     └────────────────── TIMER ────────────────┘
```

---

## 现代工具库

| 库                  | 语言/平台             | 特点                     |
| ------------------- | --------------------- | ------------------------ |
| XState              | JavaScript/TypeScript | 功能完整，支持可视化工具 |
| Zustand + FSM       | JavaScript            | 轻量级状态管理           |
| Spring Statemachine | Java                  | 企业级状态机框架         |
| Boost.MSM           | C++                   | 高性能元编程状态机       |
| Stateless           | .NET                  | 简洁的有限状态机库       |

---

## 相关概念

- **[图灵完备](./图灵完备.md)**：状态机的理论上限
- **[正则表达式](./正则表达式.md)**：有限自动机的实际应用
- **[编译原理](./编译原理.md)**：词法/语法分析中的应用
