# MTProto 协议深度解析

> 🚧 **撰写中** - 深入分析 Telegram 自研的移动优先加密协议

## 概述

MTProto（Mobile Telegram
Protocol）是 Telegram 自主研发的网络传输协议，由联合创始人 **Nikolai
Durov**（数学天才，三届 IMO 金牌得主）设计。该协议专为移动设备优化，兼顾安全性与性能。

**当前版本**：MTProto 2.0（自 Telegram 4.6 起使用）

**核心设计目标**：

- 🔒 **安全性**：多层加密 + 前向保密
- 🚀 **速度**：弱网环境下依然流畅
- 📱 **移动优先**：针对移动网络特性优化
- 🔄 **可靠性**：自动重连、消息确认机制

---

## 目录

- [协议架构](#协议架构)
- [三层结构详解](#三层结构详解)
  - [高层组件（API 查询语言）](#1-高层组件api-查询语言)
  - [加密层（授权层）](#2-加密层授权层)
  - [传输层](#3-传输层)
- [密钥体系](#密钥体系)
  - [Authorization Key（授权密钥）](#authorization-key授权密钥)
  - [Message Key（消息密钥）](#message-key消息密钥)
  - [密钥派生流程](#密钥派生流程)
- [加密算法](#加密算法)
- [消息结构](#消息结构)
- [云端加密 vs 端到端加密](#云端加密-vs-端到端加密)
- [前向保密机制](#前向保密机制)
- [与其他协议对比](#与其他协议对比)
- [安全争议与评价](#安全争议与评价)
- [参考资料](#参考资料)

---

## 协议架构

MTProto 协议被划分为三个**相对独立**的层次：

```
┌─────────────────────────────────────────────────────┐
│           High-Level Component (API)                │  ← 定义 RPC 调用格式
├─────────────────────────────────────────────────────┤
│        Cryptographic (Authorization) Layer          │  ← 消息加密/解密
├─────────────────────────────────────────────────────┤
│              Transport Component                    │  ← 网络传输（TCP/UDP/WS）
└─────────────────────────────────────────────────────┘
```

这种分层设计使得每一层可以独立升级和优化。

---

## 三层结构详解

### 1. 高层组件（API 查询语言）

**职责**：定义客户端与服务器之间的消息格式和 RPC 调用方式。

**核心概念**：

| 概念                  | 说明                                              |
| --------------------- | ------------------------------------------------- |
| **Session（会话）**   | 绑定到设备/应用，而非单一连接。多个连接可共享会话 |
| **Message ID**        | 64 位消息标识符，用于去重和排序                   |
| **Sequence Number**   | 32 位序列号，确保消息顺序                         |
| **Container（容器）** | 可将多条消息打包成一个容器，减少网络开销          |

**消息类型**：

- RPC 调用（客户端 → 服务器）
- RPC 响应（服务器 → 客户端）
- 消息确认（ACK）
- 消息状态查询
- 容器消息（多条消息打包）

**数据序列化**：

- 使用 **TL（Type Language）** 描述数据结构
- 所有数字采用**小端序**（Little Endian）
- RSA/DH 大数采用**大端序**（Big Endian）
- 消息体长度必须是 4 字节的倍数

---

### 2. 加密层（授权层）

**职责**：在消息传输前进行加密。

🚧 **待补充**：

- [ ] 加密流程详解
- [ ] 密钥交换过程
- [ ] 服务端盐（Server Salt）机制

---

### 3. 传输层

**职责**：将加密后的消息通过网络传输。

**支持的传输协议**：

| 协议           | 特点                 |
| -------------- | -------------------- |
| **TCP**        | 主流方式，稳定可靠   |
| **UDP**        | 低延迟，用于语音通话 |
| **HTTP/HTTPS** | 穿透防火墙           |
| **WebSocket**  | Web 客户端使用       |

🚧 **待补充**：

- [ ] 各协议的包格式
- [ ] 负载均衡与连接复用

---

## 密钥体系

### Authorization Key（授权密钥）

- **长度**：2048 位
- **生成方式**：Diffie-Hellman 密钥交换
- **生命周期**：设备首次连接时生成，几乎永不更换
- **存储**：仅存储于客户端和服务器，**从不在网络上传输**

### Message Key（消息密钥）

- **长度**：128 位
- **计算方式**：取消息体 SHA-256 哈希的中间 128 位
- **作用**：与 Authorization Key 共同派生 AES 密钥和 IV

### 密钥派生流程

🚧 **待补充**：详细的密钥派生算法图解

---

## 加密算法

MTProto 2.0 使用以下密码学原语：

| 算法               | 用途                             |
| ------------------ | -------------------------------- |
| **AES-256-IGE**    | 消息体加密（256 位密钥）         |
| **RSA-2048**       | 密钥交换、身份验证               |
| **SHA-256**        | 哈希计算（MTProto 1.0 用 SHA-1） |
| **Diffie-Hellman** | 生成 Authorization Key           |

🚧 **待补充**：

- [ ] IGE 模式详解
- [ ] 为什么选择 IGE 而非 CBC/GCM

---

## 消息结构

🚧 **待补充**：消息头和消息体的二进制格式

---

## 云端加密 vs 端到端加密

| 特性           | 云端加密（普通聊天） | 端到端加密（Secret Chat） |
| -------------- | -------------------- | ------------------------- |
| **加密范围**   | 客户端 ↔ 服务器      | 客户端 ↔ 客户端           |
| **服务器可读** | ✅ 理论上可以        | ❌ 无法解密               |
| **多设备同步** | ✅ 支持              | ❌ 仅限发起设备           |
| **消息存储**   | 云端永久存储         | 不存储，阅后可焚          |
| **默认启用**   | ✅ 是                | ❌ 需手动开启             |

---

## 前向保密机制

🚧 **待补充**：MTProto 如何实现 Perfect Forward Secrecy

---

## 与其他协议对比

| 协议                | 使用者           | 开源 | 默认 E2E | 特点           |
| ------------------- | ---------------- | ---- | -------- | -------------- |
| **MTProto**         | Telegram         | ❌   | ❌       | 移动优化，自研 |
| **Signal Protocol** | Signal, WhatsApp | ✅   | ✅       | 业界标准       |
| **Proteus**         | Wire             | ✅   | ✅       | 基于 Signal    |
| **MLS**             | 新标准           | ✅   | ✅       | IETF 标准化中  |

---

## 安全争议与评价

### 正面评价

- 2017 年学术论文证明 MTProto 2.0 满足 IND-CCA 安全性
- 端到端加密通过形式化验证

### 争议与批评

- **自研协议**：未使用 Signal Protocol 等经过更广泛审计的协议
- **非默认 E2E**：普通聊天不启用端到端加密，引发隐私担忧
- **IGE 模式**：部分密码学家认为应使用 AEAD 模式（如 AES-GCM）

---

## 参考资料

### 官方文档

- [MTProto 协议概述](https://core.telegram.org/mtproto)
- [MTProto 详细描述](https://core.telegram.org/mtproto/description)
- [创建 Authorization Key](https://core.telegram.org/mtproto/auth_key)
- [端到端加密（Secret Chats）](https://core.telegram.org/api/end-to-end)
- [TL 语言规范](https://core.telegram.org/mtproto/TL)
- [安全指南](https://core.telegram.org/mtproto/security_guidelines)

### 学术论文

🚧 待补充

---

**最后更新**：2026 年 1 月
