# Telegram å®¢æˆ·ç«¯æ¶æ„æ·±åº¦è§£æ

> æ·±å…¥å‰–æ Telegram 'æè‡´é€Ÿåº¦' èƒŒåçš„å·¥ç¨‹å®ç°

## 1. å·¥ç¨‹å“²å­¦ï¼šNative First

åœ¨ React Nativeã€Flutter ç­‰è·¨å¹³å°æ¡†æ¶ç››è¡Œçš„ä»Šå¤©ï¼ŒTelegram å§‹ç»ˆåšæŒ **'Native
First'ï¼ˆåŸç”Ÿä¼˜å…ˆï¼‰** çš„å·¥ç¨‹å“²å­¦ã€‚

**ä¸ºä»€ä¹ˆä¸é€‰æ‹©è·¨å¹³å°æ¡†æ¶ï¼Ÿ**

- è€ƒé‡ç»´åº¦ï¼š**å¯åŠ¨é€Ÿåº¦**ï¼›Native å®ç°çš„ä¼˜åŠ¿ï¼šæ¯«ç§’çº§å†·å¯åŠ¨ï¼›è·¨å¹³å°æ¡†æ¶çš„ç—›ç‚¹ï¼šéœ€è¦åŠ è½½ JS
  Bundle æˆ– Dart VM
- è€ƒé‡ç»´åº¦ï¼š**æ»šåŠ¨æ€§èƒ½**ï¼›Native å®ç°çš„ä¼˜åŠ¿ï¼š60fps /
  120fps ä¸èˆ¬é¡ºæ»‘ï¼›è·¨å¹³å°æ¡†æ¶çš„ç—›ç‚¹ï¼šå¤æ‚åˆ—è¡¨å®¹æ˜“æ‰å¸§
- è€ƒé‡ç»´åº¦ï¼š**å†…å­˜å ç”¨**ï¼›Native å®ç°çš„ä¼˜åŠ¿ï¼šæä½ï¼ˆC++ æ ¸å¿ƒä¼˜åŒ–ï¼‰ï¼›è·¨å¹³å°æ¡†æ¶çš„ç—›ç‚¹ï¼šè¾ƒé«˜ï¼Œæ˜“è§¦å‘ OOM
- è€ƒé‡ç»´åº¦ï¼š**UI ç»†èŠ‚**ï¼›Native å®ç°çš„ä¼˜åŠ¿ï¼šå®Œç¾è´´åˆå¹³å°è§„èŒƒï¼ˆiOS æ¨¡ç³Šã€Android æ¶Ÿæ¼ªï¼‰ï¼›è·¨å¹³å°æ¡†æ¶çš„ç—›ç‚¹ï¼šéš¾ä»¥åšåˆ°åƒç´ çº§è¿˜åŸ
- è€ƒé‡ç»´åº¦ï¼š**ç”µæ± ç»­èˆª**ï¼›Native å®ç°çš„ä¼˜åŠ¿ï¼šé«˜æ•ˆåˆ©ç”¨ç¡¬ä»¶ç‰¹æ€§ï¼›è·¨å¹³å°æ¡†æ¶çš„ç—›ç‚¹ï¼šCPU å ç”¨è¾ƒé«˜

Telegram å›¢é˜Ÿè®¤ä¸ºï¼Œ**åªæœ‰æ¦¨å¹²æ¯ä¸ªå¹³å°çš„åŸç”Ÿç‰¹æ€§ï¼Œæ‰èƒ½æä¾›æè‡´çš„ç”¨æˆ·ä½“éªŒ**ã€‚

---

## 2. å®˜æ–¹å®¢æˆ·ç«¯æ¶æ„è¯¦è§£

Telegram çš„ä¸åŒå¹³å°å®¢æˆ·ç«¯å¹¶éç®€å•çš„ 'æ¢çš®'ï¼Œè€Œæ˜¯é’ˆå¯¹è¯¥å¹³å°ç‰¹æ€§é‡æ–°è®¾è®¡çš„å·¥ç¨‹è‰ºæœ¯å“ã€‚

### ğŸ iOS (The Flagship) â€” æºç çº§æ·±åº¦è§£æ

iOS ç‰ˆé€šå¸¸è¢«è§†ä¸º Telegram çš„æ——èˆ°ä½“éªŒï¼Œå…¶æµç•…åº¦ä¸šç•Œé—»åã€‚æ•´ä¸ªé¡¹ç›®è¶…è¿‡
**200 ä¸‡è¡Œä»£ç **ï¼ŒåŒ…å« **200+ ä¸ªå­æ¨¡å—**ï¼Œæ˜¯ iOS å·¥ç¨‹çš„æ•™ç§‘ä¹¦çº§å®ç°ã€‚

#### 2.1.1 ä»£ç ç»“æ„ä¸æ¨¡å—åŒ–

**è¯­è¨€ç»„æˆ**ï¼šSwift (~70%) + Objective-C/C++ (~24%) + å…¶ä»– (~6%)

**äº”å¤§æ¨¡å—åˆ†ç±»**ï¼š

```text
Telegram-iOS/
â”œâ”€â”€ submodules/
â”‚   â”œâ”€â”€ App/              # æ ¸å¿ƒåº”ç”¨åŠŸèƒ½
â”‚   â”‚   â”œâ”€â”€ TelegramCore/     # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ TelegramUI/       # UI ç»„ä»¶åº“
â”‚   â”‚   â”œâ”€â”€ Display/          # è‡ªå®šä¹‰ Node ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ ItemListUI/       # åˆ—è¡¨ UI ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ AccountContext/   # è´¦æˆ·ä¸Šä¸‹æ–‡ç®¡ç†
â”‚   â”‚   â””â”€â”€ ...               # 100+ å…¶ä»–æ¨¡å—
â”‚   â”œâ”€â”€ VoIP/             # è¯­éŸ³/è§†é¢‘é€šè¯
â”‚   â”‚   â”œâ”€â”€ libtgvoip/        # åº•å±‚ VoIP åº“ (C++)
â”‚   â”‚   â””â”€â”€ CallKit/          # iOS ç³»ç»Ÿé€šè¯é›†æˆ
â”‚   â”œâ”€â”€ Watch/            # Apple Watch åº”ç”¨
â”‚   â”œâ”€â”€ TON/              # Telegram Open Network (å®éªŒæ€§)
â”‚   â””â”€â”€ 3rd-party/        # ç¬¬ä¸‰æ–¹ä¾èµ–
â”‚       â”œâ”€â”€ AsyncDisplayKit/  # å®šåˆ¶ç‰ˆ Texture
â”‚       â”œâ”€â”€ SQLCipher/        # åŠ å¯†æ•°æ®åº“
â”‚       â”œâ”€â”€ Lottie/           # åŠ¨ç”»åº“
â”‚       â””â”€â”€ ...
```

---

#### 2.1.2 æ„å»ºç³»ç»Ÿï¼šBazel

Telegram iOS ä½¿ç”¨
**Bazel**ï¼ˆGoogle çš„å¼€æºæ„å»ºå·¥å…·ï¼‰ç®¡ç†æ•´ä¸ªé¡¹ç›®ï¼Œæ—©æœŸæ›¾ä½¿ç”¨ Buckï¼ˆFacebook çš„æ„å»ºç³»ç»Ÿï¼‰ã€‚

**é€‰æ‹© Bazel çš„åŸå› **ï¼š

1. **å¢é‡æ„å»º**ï¼šåªé‡æ–°ç¼–è¯‘å˜æ›´çš„æ¨¡å—ï¼Œå¤§å‹é¡¹ç›®æ„å»ºæ—¶é—´ä» 10+ åˆ†é’Ÿç¼©çŸ­åˆ°ç§’çº§
2. **ä¾èµ–ç®¡ç†**ï¼šè‡ªåŠ¨è§£æ 200+ æ¨¡å—é—´çš„å¤æ‚ä¾èµ–å…³ç³»
3. **å¯å¤ç°æ„å»º**ï¼šç¡®ä¿å¼€æºä»£ç ç¼–è¯‘ç»“æœä¸ App Store ç‰ˆæœ¬å®Œå…¨ä¸€è‡´
4. **è·¨å¹³å°æ”¯æŒ**ï¼šæ”¯æŒ macOSã€iOSã€watchOS å¤šç›®æ ‡ç¼–è¯‘

**æ„å»ºæµç¨‹**ï¼š

```bash
# 1. ç”Ÿæˆ Xcode é¡¹ç›®ï¼ˆç”¨äºå¼€å‘è°ƒè¯•ï¼‰
python3 build-system/Make/Make.py \
    --cacheDir="$HOME/telegram-bazel-cache" \
    generateProject \
    --configurationPath=path/to/configuration

# 2. æ„å»º IPAï¼ˆå‘å¸ƒåŒ…ï¼‰
python3 build-system/Make/Make.py \
    --cacheDir="$HOME/telegram-bazel-cache" \
    build \
    --configuration=release_arm64
```

> **ğŸ“Œ å…³é”®æ–‡ä»¶**ï¼š
>
> - `build-system/Make/Make.py` â€” ä¸»æ„å»ºè„šæœ¬
> - `WORKSPACE` â€” Bazel å·¥ä½œåŒºé…ç½®
> - `BUILD` æ–‡ä»¶ â€” å„æ¨¡å—çš„æ„å»ºè§„åˆ™

---

#### 2.1.3 ç½‘ç»œå±‚ï¼šMTProtoKit

Telegram iOS **å¹¶æœªä½¿ç”¨ TDLib**ï¼Œè€Œæ˜¯ç»´æŠ¤äº†ä¸€å¥—å®Œå…¨ç‹¬ç«‹çš„ Objective-C ç½‘ç»œå±‚
`MtProtoKit`ï¼Œä¸“ä¸º iOS çš„åå°æœºåˆ¶å’Œç½‘ç»œç‰¹æ€§æ·±åº¦ä¼˜åŒ–ã€‚

**æ ¸å¿ƒæ¶æ„**ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TelegramCore                         â”‚
â”‚              (ä¸šåŠ¡é€»è¾‘ + API å°è£…)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MtProtoKit                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  MTProto 2.0 åè®®å®ç°                            â”‚   â”‚
â”‚  â”‚  â€¢ AES-256-IGE åŠ å¯†                             â”‚   â”‚
â”‚  â”‚  â€¢ SHA-256 æ¶ˆæ¯è®¤è¯                             â”‚   â”‚
â”‚  â”‚  â€¢ RSA-2048 å¯†é’¥äº¤æ¢                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ä¼ è¾“å±‚                                          â”‚   â”‚
â”‚  â”‚  â€¢ TCP (ä¸»è¦) / HTTP / WebSocket                â”‚   â”‚
â”‚  â”‚  â€¢ è‡ªåŠ¨ DC è¿ç§»                                 â”‚   â”‚
â”‚  â”‚  â€¢ ç½‘ç»œçŠ¶æ€ç›‘æµ‹ + é‡è¿ç­–ç•¥                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**iOS ä¸“å±ä¼˜åŒ–**ï¼š

| ç‰¹æ€§           | å®ç°æ–¹å¼                                         |
| -------------- | ------------------------------------------------ |
| **åå°ä¿æ´»**   | åˆ©ç”¨ PushKit VoIP æ¨é€æ¥æ”¶åå°æ•°æ®ï¼ˆéä»…é€šè¯ï¼‰   |
| **å®æ—¶ä½ç½®**   | åå°ä½ç½®æ›´æ–°é€šè¿‡ VoIP æ¨é€è§¦å‘ï¼Œè€Œéä¼ ç»Ÿä½ç½®æœåŠ¡ |
| **æœªè¯»è®¡æ•°**   | é€šè¿‡ VoIP æ¨é€éšå¼æ›´æ–°ï¼Œæ— éœ€å”¤é†’ä¸» App           |
| **å¤š DC è¿æ¥** | åŒæ—¶ç»´æŠ¤åˆ°å¤šä¸ªæ•°æ®ä¸­å¿ƒçš„è¿æ¥ï¼Œæ™ºèƒ½åˆ‡æ¢           |

> **ğŸ”— æºç è·¯å¾„**ï¼š`submodules/MtProtoKit/Sources/`

---

#### 2.1.4 UI æ¡†æ¶ï¼šæ·±åº¦å®šåˆ¶çš„ AsyncDisplayKit

Telegram å¯¹ AsyncDisplayKitï¼ˆç°å Textureï¼‰è¿›è¡Œäº†**æ¿€è¿›çš„å®šåˆ¶**ï¼Œç§»é™¤äº†çº¦
**65%** çš„åŸå§‹ä»£ç ã€‚

**å®šåˆ¶ç­–ç•¥**ï¼š

| åŸç‰ˆåŠŸèƒ½                           | Telegram å¤„ç†                  |
| ---------------------------------- | ------------------------------ |
| `ASTableNode` / `ASCollectionNode` | âŒ ç§»é™¤ï¼Œä½¿ç”¨è‡ªç ” `ListView`   |
| Flexbox + Yoga å¸ƒå±€å¼•æ“            | âŒ ç§»é™¤ï¼Œé‡‡ç”¨æ‰‹åŠ¨å¸ƒå±€          |
| `ASNetworkImageNode`               | âŒ ç§»é™¤ï¼Œå›  MTProto ä¸‹è½½ä¸å…¼å®¹ |
| `ASViewController`                 | âŒ ç§»é™¤ï¼Œè‡ªç ” `ViewController` |
| æ ¸å¿ƒ Node ç³»ç»Ÿ                     | âœ… ä¿ç•™å¹¶æ‰©å±•                  |

**è‡ªç ” Node ä½“ç³»**ï¼ˆåˆ†å¸ƒåœ¨ `Display`ã€`TelegramUI`ã€`ItemListUI` ç­‰æ¨¡å—ï¼‰ï¼š

```swift
// æ ¸å¿ƒæŠ½è±¡ â€”â€” æ‰€æœ‰ UI ç»„ä»¶çš„åŸºç±»
class ASDisplayNode {
    var view: UIView { get }           // æƒ°æ€§åˆ›å»º UIView
    var layer: CALayer { get }

    // å…³é”®æ–¹æ³•ï¼šå¼‚æ­¥å¸ƒå±€è®¡ç®—
    func asyncLayout() -> (CGSize) -> (CGSize, () -> Void) {
        // è¿”å›ä¸€ä¸ªé—­åŒ…ï¼Œå¯åœ¨åå°çº¿ç¨‹æ‰§è¡Œå¸ƒå±€è®¡ç®—
        // ç¬¬äºŒä¸ªé—­åŒ…åœ¨ä¸»çº¿ç¨‹åº”ç”¨å¸ƒå±€ç»“æœ
    }
}

// Telegram æ‰©å±•çš„ä¸“ç”¨ Node
â”œâ”€â”€ TextNode                    // å¯Œæ–‡æœ¬æ¸²æŸ“ (åŸºäº CoreText)
â”œâ”€â”€ ImmediateTextNode           // å¿«é€Ÿæ–‡æœ¬æ¸²æŸ“
â”œâ”€â”€ ImageNode                   // å›¾ç‰‡æ˜¾ç¤º
â”œâ”€â”€ AnimatedStickerNode         // Lottie åŠ¨ç”»è´´çº¸
â”œâ”€â”€ MediaPlayNode               // è§†é¢‘å¸§æ¸²æŸ“
â”œâ”€â”€ WebEmbedPlayerNode          // å†…åµŒç½‘é¡µæ’­æ”¾å™¨
â”œâ”€â”€ ChatMessageBubbleItemNode   // èŠå¤©æ°”æ³¡å®¹å™¨
â””â”€â”€ ... (æ•°ç™¾ä¸ªè‡ªå®šä¹‰ Node)
```

**æ‰‹åŠ¨å¸ƒå±€ç¤ºä¾‹**ï¼š

```swift
// TelegramUI/ChatMessageBubbleItemNode.swift ä¸­çš„å¸ƒå±€é€»è¾‘
static func asyncLayout(_ item: ChatMessageItem)
    -> (CGFloat, CGFloat) -> (CGSize, (ListViewItemUpdateAnimation) -> Void) {

    // ç¬¬ä¸€é˜¶æ®µï¼šåå°çº¿ç¨‹è®¡ç®—
    return { width, height in
        let messageWidth = width - 80  // æ‰‹åŠ¨è®¡ç®—è¾¹è·
        let textLayout = TextNode.asyncLayout(item.text)(messageWidth)
        let bubbleHeight = textLayout.size.height + 24

        // ç¬¬äºŒé˜¶æ®µï¼šä¸»çº¿ç¨‹åº”ç”¨
        return (CGSize(width: width, height: bubbleHeight), { animation in
            self.textNode.frame = CGRect(x: 12, y: 8,
                                          width: textLayout.size.width,
                                          height: textLayout.size.height)
        })
    }
}
```

---

#### 2.1.5 å“åº”å¼ç¼–ç¨‹ï¼šSSignalKit / SwiftSignalKit

Telegram å®Œå…¨**é¿å¼€äº† RxSwift / Combine**ï¼Œè‡ªç ”äº†è½»é‡çº§å“åº”å¼æ¡†æ¶ã€‚

**æ¼”è¿›å†å²**ï¼š

- `MTSignal` â†’ Objective-C ç‰ˆæœ¬ï¼Œç”¨äº MtProtoKit
- `SSignalKit` â†’ Objective-C å¢å¼ºç‰ˆ
- `SwiftSignalKit` â†’ Swift ç§»æ¤ç‰ˆï¼Œç°ä¸ºä¸»åŠ›

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š

```swift
// Signal â€”â€” ä»£è¡¨ä¸€ä¸ªå¼‚æ­¥å€¼åºåˆ—
public final class Signal<T, E> {
    public func start(next: @escaping (T) -> Void,
                      error: @escaping (E) -> Void,
                      completed: @escaping () -> Void) -> Disposable
}

// Promise â€”â€” å¯å†™å…¥çš„å•å€¼ä¿¡å·
public final class Promise<T> {
    public var signal: Signal<T, NoError>
    public func set(_ signal: Signal<T, NoError>)
}

// å®é™…ä½¿ç”¨ç¤ºä¾‹ â€”â€” è·å–èŠå¤©åˆ—è¡¨
func fetchChatList() -> Signal<[Chat], MTRpcError> {
    return network.request(Api.messages.getDialogs(...))
        |> mapToSignal { dialogs -> Signal<[Chat], MTRpcError> in
            return processDialogs(dialogs)
        }
        |> deliverOnMainQueue
}

// UI ç»‘å®š
self.chatListDisposable = fetchChatList().start(next: { [weak self] chats in
    self?.updateChatList(chats)
}, error: { error in
    // å¤„ç†é”™è¯¯
})
```

**ä¸ºä½•è‡ªç ”ï¼Ÿ**

1. **é›¶ä¾èµ–**ï¼šä¸å—ç¬¬ä¸‰æ–¹åº“ç‰ˆæœ¬å’Œ API å˜æ›´å½±å“
2. **æè‡´è½»é‡**ï¼šæ ¸å¿ƒä»£ç çº¦ 2000 è¡Œï¼ŒRxSwift çº¦ 20000 è¡Œ
3. **å®Œå…¨æ§åˆ¶**ï¼šå¯é’ˆå¯¹ Telegram ç‰¹å®šåœºæ™¯æ·±åº¦ä¼˜åŒ–

---

#### 2.1.6 æ•°æ®å­˜å‚¨ï¼šPostbox + SQLite

**å­˜å‚¨æ¶æ„**ï¼š

```text
Container/
â””â”€â”€ telegram-data/                    # Group Container (å…±äº«ç»™ App Extension)
    â””â”€â”€ account-{id}/
        â””â”€â”€ postbox/
            â””â”€â”€ db/
                â””â”€â”€ db_sqlite         # ä¸»æ•°æ®åº“ (SQLCipher åŠ å¯†)
```

**æŠ€æœ¯æ ˆ**ï¼š

| ç»„ä»¶             | ç”¨é€”                          |
| ---------------- | ----------------------------- |
| **SQLite**       | æ ¸å¿ƒå­˜å‚¨å¼•æ“                  |
| **SQLCipher**    | æ•°æ®åº“å…¨ç›˜åŠ å¯†                |
| **FTS5**         | å…¨æ–‡æœç´¢ï¼ˆæ¶ˆæ¯æœç´¢åŠŸèƒ½ï¼‰      |
| **è‡ªå®šä¹‰åºåˆ—åŒ–** | TL (Type Language) äºŒè¿›åˆ¶æ ¼å¼ |

**Postbox æ ¸å¿ƒæ¨¡å—**ï¼š

```swift
// submodules/Postbox/Sources/Postbox.swift
public final class Postbox {
    // æ¶ˆæ¯å­˜å‚¨
    public func messageHistory(peerId: PeerId) -> Signal<[Message], NoError>

    // äº‹åŠ¡æ“ä½œ
    public func transaction<T>(_ f: @escaping (Transaction) -> T) -> Signal<T, NoError>

    // å®æ—¶ç›‘å¬å˜æ›´
    public func messageHistoryObserver(peerId: PeerId) -> Signal<MessageHistoryUpdate, NoError>
}
```

**æ•°æ®å…±äº«**ï¼š

- ä¸» Appã€Widgetã€Share Extensionã€Watch App é€šè¿‡ **App Group Container**
  å…±äº«åŒä¸€æ•°æ®åº“
- ä½¿ç”¨ Darwin notify æœºåˆ¶åœ¨è¿›ç¨‹é—´åŒæ­¥æ•°æ®å˜æ›´

---

#### 2.1.7 æ¶ˆæ¯åˆ—è¡¨æ¸²æŸ“ï¼šListView + ChatMessageBubbleContentNode

èŠå¤©åˆ—è¡¨æ˜¯ Telegram æ€§èƒ½çš„æ ¸å¿ƒæˆ˜åœºã€‚åœ¨ iPhone 6s (iOS 13.5) ä¸Šå®æµ‹å¯ä¿æŒ **58+
FPS**ã€‚

**æ ¸å¿ƒç»„ä»¶å±‚æ¬¡**ï¼š

```text
ChatHistoryListNode (ListView å­ç±»)
â””â”€â”€ ChatMessageBubbleItemNode (æ°”æ³¡å®¹å™¨)
    â””â”€â”€ ChatMessageBubbleContentNode (å†…å®¹èŠ‚ç‚¹)
        â”œâ”€â”€ ChatMessageTextBubbleContentNode        # çº¯æ–‡æœ¬
        â”œâ”€â”€ ChatMessageMediaBubbleContentNode       # å›¾ç‰‡/è§†é¢‘
        â”œâ”€â”€ ChatMessageFileBubbleContentNode        # æ–‡ä»¶é™„ä»¶
        â”œâ”€â”€ ChatMessageWebpageBubbleContentNode     # é“¾æ¥é¢„è§ˆ
        â”œâ”€â”€ ChatMessageAnimatedStickerContentNode   # åŠ¨ç”»è´´çº¸
        â”œâ”€â”€ ChatMessageVoiceContentNode             # è¯­éŸ³æ¶ˆæ¯
        â””â”€â”€ ... (æ›´å¤šå†…å®¹ç±»å‹)
```

**åˆ—è¡¨å€’ç½®æŠ€å·§**ï¼š

```swift
// ListView é€šè¿‡ CATransform3D æ—‹è½¬ 180Â°
listView.transform = CATransform3DMakeRotation(CGFloat.pi, 1, 0, 0)

// æ¯ä¸ª Cell å†åå‘æ—‹è½¬ 180Â°
cell.transform = CATransform3DMakeRotation(CGFloat.pi, 1, 0, 0)

// æ•ˆæœï¼šæ»šåŠ¨æ–¹å‘è‡ªç„¶ï¼Œæ–°æ¶ˆæ¯ä»åº•éƒ¨å‡ºç°
```

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **å®Œå…¨å¼‚æ­¥æ¸²æŸ“**ï¼šæ–‡æœ¬ (CoreText)ã€å›¾ç‰‡è§£ç ã€å¸ƒå±€è®¡ç®—å…¨éƒ¨åœ¨åå°çº¿ç¨‹
2. **é¢„è®¡ç®—ç¼“å­˜**ï¼š`asyncLayout` è¿”å›çš„å¸ƒå±€ç»“æœå¯ç¼“å­˜å¤ç”¨
3. **æ¸è¿›å¼åŠ è½½**ï¼šå¿«é€Ÿæ»šåŠ¨æ—¶æ˜¾ç¤ºå ä½ç¬¦ï¼Œåœæ­¢ååŠ è½½çœŸå®å†…å®¹
4. **æ™ºèƒ½å¤ç”¨**ï¼šNode å±‚çº§çš„ Cell å¤ç”¨ï¼Œæ¯” UITableViewCell æ›´è½»é‡

---

#### 2.1.8 UIKit é‡æ–°å®ç°

Telegram å¯¹ç³»ç»Ÿ UIKit ç»„ä»¶çš„è¡Œä¸ºä¸æ»¡æ„ï¼Œ**ä»é›¶é‡å†™äº†å¤šä¸ªæ ¸å¿ƒæ§åˆ¶å™¨**ï¼š

```swift
// è‡ªç ”æ§åˆ¶å™¨ vs ç³»ç»Ÿæ§åˆ¶å™¨
NavigationController      // æ›¿ä»£ UINavigationController
TabBarController          // æ›¿ä»£ UITabBarController
AlertController           // æ›¿ä»£ UIAlertController
ActionSheetController     // æ›¿ä»£ UIAlertController (ActionSheet)
ContextMenuController     // æ›¿ä»£ UIContextMenuInteraction
```

**é‡å†™åŸå› **ï¼š

- ç³»ç»Ÿæ§åˆ¶å™¨åœ¨ä¸åŒ iOS ç‰ˆæœ¬è¡Œä¸ºä¸ä¸€è‡´
- æ— æ³•å®Œå…¨æ§åˆ¶åŠ¨ç”»æ›²çº¿å’Œæ—¶é•¿
- ç³»ç»Ÿç»„ä»¶çš„æ‰‹åŠ¿å†²çªéš¾ä»¥è§£å†³
- éœ€è¦æ”¯æŒå¤æ‚çš„è‡ªå®šä¹‰è½¬åœº

---

> **ğŸ”— æºç å‚è€ƒ**ï¼š
>
> - [Telegram-iOS GitHub](https://github.com/TelegramMessenger/Telegram-iOS)
> - [Texture å®˜æ–¹æ–‡æ¡£](https://texturegroup.org/)
> - [MTProto åè®®æ–‡æ¡£](https://core.telegram.org/mtproto)

### ğŸ¤– Android (Official vs X)

Android ç”Ÿæ€å­˜åœ¨è‘—åçš„ 'åŒå®¢æˆ·ç«¯' ç­–ç•¥ï¼Œå±•ç¤ºäº†ä¸¤ç§ä¸åŒçš„æ¶æ„æ€è·¯ã€‚

#### å®˜æ–¹ç‰ˆ (Telegram for Android)

- **å®šä½**ï¼šç¨³å®šã€å…¼å®¹æ€§å¥½ã€åŠŸèƒ½æœ€å…¨ã€‚
- **æ¶æ„**ï¼š
  - **è¯­è¨€**ï¼šJava (ä¸»è¦) + C++ (JNI)ã€‚
  - **æ ¸å¿ƒ**ï¼šç›´æ¥å®ç° MTProtoï¼ŒUI å±‚å¤§é‡ä½¿ç”¨è‡ªå®šä¹‰ Viewã€‚
  - **å¯å¤ç°æ„å»º (Reproducible Builds)**ï¼š
    - Telegram æ˜¯å°‘æ•°æ”¯æŒ Android å¯å¤ç°æ„å»ºçš„ä¸»æµ Appã€‚
    - ç”¨æˆ·å¯ä»¥ä½¿ç”¨ Docker ç¯å¢ƒï¼ŒåŸºäºå…¬å¼€æºç ç¼–è¯‘å‡ºä¸ Google
      Play ä¸€æ¨¡ä¸€æ ·çš„ APKã€‚
    - éªŒè¯å·¥å…·ï¼š`apkdiff.py`
      å¯å¯¹æ¯”è‡ªç¼–è¯‘åŒ…ä¸å®˜æ–¹åŒ…çš„äºŒè¿›åˆ¶å·®å¼‚ï¼ˆé€šå¸¸ä»…ç­¾åä¸åŒï¼‰ã€‚

#### Telegram X

- **å®šä½**ï¼šå®éªŒæ€§ã€æ›´ç°ä»£ã€åŠ¨ç”»æ›´å¤šã€‚
- **æ¶æ„**ï¼š**åŸºäº TDLib**ã€‚
- **è®¾è®¡ç›®æ ‡**ï¼šéªŒè¯ TDLib åœ¨ Android ä¸Šçš„æ€§èƒ½ï¼Œå¹¶å°è¯•é€šè¿‡ C++ å…±äº«æ›´å¤šé€»è¾‘ã€‚
- **äº¤äº’**ï¼šæ‹¥æœ‰æ›´æµç•…çš„æ‰‹åŠ¿æ“ä½œå’Œå³æ—¶å¤œé—´æ¨¡å¼åˆ‡æ¢ã€‚

> **ğŸ”— æºç å‚è€ƒ**ï¼š
>
> - Telegram Android <https://github.com/DrKLO/Telegram>
> - Reproducible Builds æŒ‡å— <https://core.telegram.org/reproducible-builds>

### ğŸŒ Web (K & Z)

Telegram Web ä¸ä»…ä»…æ˜¯ç½‘é¡µï¼Œæ›´æ˜¯ **WebAssembly (WASM)**
çš„æ•™ç§‘ä¹¦çº§åº”ç”¨ã€‚ç”±äºå†å²åŸå› ï¼ˆLightweight Client Contestï¼‰ï¼Œå­˜åœ¨ä¸¤ä¸ªå®˜æ–¹ç‰ˆæœ¬ã€‚

- **Web Z (Z ç‰ˆæœ¬)**ï¼š
  - **æ¡†æ¶**ï¼š**Teact**ï¼ˆè‡ªç ”çš„ç±» React æ¡†æ¶ï¼Œæ›´è½»é‡ï¼Œå»é™¤äº† React çš„å…¼å®¹æ€§åŒ…è¢±ï¼‰ +
    TypeScriptã€‚
  - **åè®®**ï¼šè‡ªå®šä¹‰ MTProto JS å®ç°ã€‚
- **Web K (K ç‰ˆæœ¬)**ï¼š
  - **æ¡†æ¶**ï¼šåŸç”Ÿ TypeScriptï¼Œæ— é‡å‹æ¡†æ¶ä¾èµ–ï¼Œæ¶æ„æ›´æ¥è¿‘ 'Vanilla JS'ã€‚
- **WASM çš„æ·±åº¦åº”ç”¨**ï¼š
  - **åŠ å¯†è§£å¯†**ï¼šAES-IGEã€SHA-256 ç­‰é«˜é¢‘åŠ å¯†æ“ä½œç¼–è¯‘ä¸º WASM æ¨¡å—ï¼Œæ€§èƒ½æ¥è¿‘åŸç”Ÿä»£ç ã€‚
  - **åª’ä½“å¤„ç†**ï¼šOpus éŸ³é¢‘ç¼–ç å™¨ã€RLottie åŠ¨ç”»æ¸²æŸ“å™¨å‡è¿è¡Œåœ¨ WASM ä¸­ï¼Œè§£å†³äº† JS å¤„ç†äºŒè¿›åˆ¶æ•°æ®çš„æ€§èƒ½ç“¶é¢ˆã€‚

> **ğŸ”— æºç å‚è€ƒ**ï¼š
>
> - Web Z æºç  <https://github.com/Ajaxy/telegram-tt>
> - Web K æºç  <https://github.com/morethanwords/tweb>

---

## 3. TDLibï¼šé€šç”¨å®¢æˆ·ç«¯å¼•æ“

**TDLib (Telegram Database Library)**
æ˜¯ Telegram å¼€æ”¾ç»™ç¬¬ä¸‰æ–¹å¼€å‘è€…çš„'æ ¸æ­¦å™¨'ã€‚å®ƒå°†å¤æ‚çš„ MTProtoåè®®ã€æœ¬åœ°å­˜å‚¨ã€ç½‘ç»œåŒæ­¥å°è£…æˆäº†ä¸€ä¸ªé»‘ç›’ã€‚

### æ¶æ„å›¾è§£

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Third-Party Client UI            â”‚
â”‚         (Swift / Kotlin / JS / Python)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ JSON / TL-Object Interface
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚      TDLib (C++)         â”‚
          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚ â”‚    Actor Model       â”‚ â”‚  â† æ ¸å¿ƒå¹¶å‘æ¨¡å‹
          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          â”‚            â”‚             â”‚
          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚ â”‚NetQueryâ”‚  â”‚ â”‚SQLite3 â”‚ â”‚  â† æœ¬åœ°æ•°æ®åº“
          â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â”‚
          â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜
                 â”‚     â”‚       â”‚
        MTProto  â–¼     â–¼       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           Telegram Cloud              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒè®¾è®¡ï¼šActor Model

TDLib çš„é«˜æ€§èƒ½æºäºå…¶å†…éƒ¨å®ç°çš„ **Actor å¹¶å‘æ¨¡å‹**ï¼š

1.  **æ— é”å¹¶å‘**ï¼šæ¯ä¸ª Actor éƒ½æ˜¯ç‹¬ç«‹çš„æ‰§è¡Œå•å…ƒï¼Œæ‹¥æœ‰ç§æœ‰çŠ¶æ€ã€‚Actor ä¹‹é—´**ç»ä¸å…±äº«å†…å­˜**ï¼Œåªé€šè¿‡æ¶ˆæ¯ä¼ é€’äº¤äº’ã€‚
2.  **é¿å…æ­»é”**ï¼šç”±äºæ¶ˆé™¤äº†å…±äº«çŠ¶æ€å’Œé”ç«äº‰ï¼ŒTDLib å‡ ä¹å½»åº•æœç»äº†å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­å¸¸è§çš„æ­»é”é—®é¢˜ã€‚
3.  **é«˜ååé‡**ï¼šè¿™ç§æ¨¡å‹éå¸¸é€‚åˆå¤„ç†å¤§é‡çš„å¹¶å‘ç½‘ç»œè¯·æ±‚ï¼ˆå¦‚åŒæ—¶åŠ è½½æˆç™¾ä¸Šåƒä¸ªèŠå¤©ä¼šè¯ï¼‰ã€‚

### å¼€å‘è€…æ¥å£

TDLib å¯¹å¤–æš´éœ²æå…¶ç®€å•çš„æ¥å£ï¼Œç±»ä¼¼äº Redux çš„å•å‘æ•°æ®æµï¼š

- **`send(function)`**ï¼šå‘é€è¯·æ±‚ï¼ˆå¦‚ `sendMessage`, `getChats`ï¼‰ã€‚
- **`receive()`**ï¼šè½®è¯¢è·å–æ›´æ–°ï¼ˆUpdatesï¼‰ï¼Œæ‰€æœ‰æ•°æ®å˜æ›´ï¼ˆæ–°æ¶ˆæ¯ã€ç”¨æˆ·ä¸Šçº¿ï¼‰éƒ½é€šè¿‡æ­¤æ¥å£å¼‚æ­¥æ¨é€ã€‚

> **ğŸ”— å®˜æ–¹æ–‡æ¡£**ï¼š
>
> - TDLib æ ¸å¿ƒæ¦‚å¿µ <https://core.telegram.org/tdlib>
> - GitHub ä»“åº“ <https://github.com/tdlib/td>

---

## 4. æ€»ç»“ï¼šTelegram çš„å·¥ç¨‹å¯ç¤º

1.  **æŒæ§æ ¸å¿ƒæŠ€æœ¯æ ˆ**ï¼šä¸ºäº†æè‡´ä½“éªŒï¼Œä¸æƒœç»´æŠ¤å®šåˆ¶ç‰ˆçš„ UI æ¡†æ¶ï¼ˆiOS
    Texture æ”¹ç‰ˆï¼‰å’Œ Web æ¡†æ¶ï¼ˆTeactï¼‰ã€‚
2.  **æ€§èƒ½è‡³ä¸Š**ï¼šå°†ç¹é‡çš„è®¡ç®—ï¼ˆåŠ å¯†ã€å¸ƒå±€ã€åª’ä½“å¤„ç†ï¼‰ä»ä¸»çº¿ç¨‹å‰¥ç¦»ï¼Œåˆ©ç”¨ C++ /
    WASM / Background Threads è§£å†³ã€‚
3.  **å¼€æ”¾ä¸é€æ˜**ï¼šé€šè¿‡å¼€æºå®¢æˆ·ç«¯ä»£ç å’Œæ”¯æŒå¯å¤ç°æ„å»ºï¼Œå»ºç«‹äº†æé«˜çš„å®‰å…¨ä¿¡ä»»åº¦ã€‚

---

## å‚è€ƒæ–‡çŒ®ä¸é“¾æ¥

- **å®˜æ–¹èµ„æº**
  - Telegram Apps Source Code <https://telegram.org/apps#source-code>
  - Reproducible Builds for Android
    <https://core.telegram.org/reproducible-builds>
  - TDLib - Telegram Database Library <https://core.telegram.org/tdlib>

- **æŠ€æœ¯åˆ†æ**
  - AsyncDisplayKit (Texture) å®˜æ–¹æ–‡æ¡£ <https://texturegroup.org/>
  - Telegram iOS æ¶æ„åˆ†æ (Hubo.dev)
    <https://hubo.dev/blog/telegram-ios-architecture/>
  - Citizen Lab å¯¹å¾®ä¿¡å®‰å…¨æ€§çš„åˆ†æ (ä½œä¸ºå¯¹æ¯”å‚è€ƒ)
    <https://citizenlab.ca/2020/05/wechat-surveillance-explained/>
